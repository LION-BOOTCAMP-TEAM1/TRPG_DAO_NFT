# 데이터베이스 업데이트 가이드

이 가이드는 TRPG DAO NFT 플랫폼의 데이터베이스를 업데이트하고 동기화하는 방법을 설명합니다.

## 자동 데이터베이스 동기화

백엔드 서버가 시작될 때 자동으로 데이터베이스 스키마 변경을 감지하고 적용합니다.

### 동작 방식

1. 서버 시작 시 `src/utils/dbSync.ts`의 `syncDatabase` 함수가 실행됩니다.
2. 현재 스키마와 데이터베이스 상태를 비교하여 변경 사항을 감지합니다.
3. 개발 환경에서는 변경 사항이 있을 경우 확인 메시지를 표시합니다.
4. 프로덕션 환경에서는 변경 사항을 자동으로 적용합니다.

## 수동 데이터베이스 관리 명령어

프로젝트 루트 디렉토리에서 다음 명령어를 사용할 수 있습니다:

### 데이터베이스 동기화

```bash
# 기본 동기화 (변경 사항만 감지 및 적용)
npm run db:sync

# 전체 동기화 (강제 마이그레이션 및 시드 데이터 적용)
npm run db:sync:full

# 원클릭 업데이트 (prisma 클라이언트 생성, 마이그레이션, 시드 데이터 적용)
npm run db:update
```

### Prisma 명령어

```bash
# Prisma 클라이언트 생성
npm run prisma:generate

# 마이그레이션 생성 및 적용
npm run prisma:migrate

# Prisma Studio 실행 (데이터베이스 GUI 관리)
npm run prisma:studio
```

### 기타 데이터베이스 관리

```bash
# 마이그레이션 상태 확인
npm run db:status

# 데이터베이스 초기화 (모든 데이터 삭제 및 처음부터 다시 적용)
npm run db:reset

# 시드 데이터만 적용
npm run seed
```

## 데이터베이스 스키마 변경 프로세스

1. `backend/prisma/schema.prisma` 파일에서 모델 구조를 업데이트합니다.
2. 개발 중에는 `npm run db:sync`를 실행하여 변경 사항을 감지하고 마이그레이션을 생성합니다.
3. 필요한 경우 `backend/src/seed` 디렉토리의 시드 데이터를 업데이트합니다.
4. 변경 사항을 테스트합니다.
5. 프로덕션 배포 시에는 서버가 시작될 때 자동으로 마이그레이션이 적용됩니다.

## 주의사항

- 프로덕션 환경에서 데이터베이스 스키마 변경은 신중하게 수행해야 합니다.
- 데이터 손실이 발생할 수 있는 변경(컬럼 삭제, 타입 변경 등)은 마이그레이션 파일을 수동으로 수정하여 안전하게 처리해야 합니다.
- 중요한 데이터베이스 변경 전에는 반드시 백업을 수행하세요.

## 문제 해결

### 마이그레이션 충돌

마이그레이션 충돌이 발생한 경우:

1. `npm run db:status`로 현재 상태를 확인합니다.
2. 충돌이 해결되지 않는 경우 `npm run db:reset`을 사용할 수 있지만, 모든 데이터가 초기화됩니다.
3. 프로덕션 환경에서는 `db:reset`을 사용하지 마세요.

### 시드 데이터 오류

시드 데이터 적용 중 오류가 발생한 경우:

1. `backend/src/seed` 디렉토리의 JSON 파일이 올바른 형식인지 확인합니다.
2. `backend/src/seed/seed.ts` 파일에서 오류가 발생한 부분을 디버깅합니다. 