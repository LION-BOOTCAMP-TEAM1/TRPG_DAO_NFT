import express from 'express';
import dotenv from 'dotenv';
import cors from 'cors';
import prisma from './prismaClient';
import { setupSwagger } from './config/swagger';
import apiRoutes from './routes';
import path from 'path';
import { 
  createTrackedInterval, 
  createTrackedTimeout, 
  clearAllTimers, 
  setupMemoryMonitoring,
  forceGC,
  clearTimeout
} from './utils/intervalManager';
import { trackMemoryUsage, generateMemoryReport } from './utils/memoryLeakDetector';

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ - ìµœìš°ì„  ì‹¤í–‰
try {
  dotenv.config();
  console.log('í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ì„±ê³µ');
} catch (e) {
  console.error('í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', e);
}

// ì„œë²„ ì¤‘ë³µ ì‹œì‘ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸
let isServerStarting = false;
let isServerRunning = false;

// Render í™˜ê²½ ê°ì§€ ë¡œì§ í†µí•©
const isRenderEnv = process.env.IS_RENDER === 'true' || process.env.RENDER === 'true';
console.log(`Render í™˜ê²½ ê°ì§€: ${isRenderEnv}`);

// ì‹œì‘ í™˜ê²½ ë¡œê¹…
console.log('==== ì„œë²„ ì‹œì‘ ====');
console.log(`NODE_ENV: ${process.env.NODE_ENV || 'development'}`);
console.log(`SKIP_DB_SYNC: ${process.env.SKIP_DB_SYNC || 'false'}`);
console.log(`PORT: ${process.env.PORT || '3000'}`);
console.log(`ì‹¤í–‰ ì‹œê°„: ${new Date().toISOString()}`);
console.log('===================');

// Render ì§„ë‹¨ ì •ë³´ ë¡œê¹…
console.log('==== Render ì§„ë‹¨ ì •ë³´ ====');
console.log('í™˜ê²½ë³€ìˆ˜ ìƒì„¸:');
[
  'NODE_ENV', 'PORT', 'SKIP_DB_SYNC', 'IS_RENDER', 'RENDER',
  'DATABASE_URL', 'DATABASE_URL_UNPOOLED'
].forEach(key => {
  const value = process.env[key];
  console.log(`${key}: ${value ? (key.includes('DATABASE') ? 'ì„¤ì •ë¨(ê°’ ìˆ¨ê¹€)' : value) : 'ì„¤ì •ì•ˆë¨'}`);
});
console.log('========================');

// ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì„¤ì •
process.on('uncaughtException', (error) => {
  console.error('===== ì¹˜ëª…ì ì¸ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸ ë°œìƒ =====');
  console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
  console.error('ì˜¤ë¥˜ ì´ë¦„:', error.name);
  console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
  console.error('=========================================');
  
  // í”„ë¡œë•ì…˜ì—ì„œëŠ” ê³„ì† ì‹¤í–‰ - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ GC íŒíŠ¸ ì¶”ê°€
  if (process.env.NODE_ENV === 'production') {
    forceGC();
  } else {
    process.exit(1);
  }
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('===== ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€ =====');
  console.error('ì‚¬ìœ :', reason);
  console.error('=========================================');
  
  // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ GC íŒíŠ¸ ì¶”ê°€
  forceGC();
});

const app = express();
// Render.comì—ì„œëŠ” í• ë‹¹ëœ PORT í™˜ê²½ ë³€ìˆ˜ë¥¼ ë°˜ë“œì‹œ ì‚¬ìš©í•´ì•¼ í•¨
const PORT = process.env.PORT ? parseInt(process.env.PORT, 10) : 3000;
const API_PREFIX = '/api';

// Express ì—ëŸ¬ í•¸ë“¤ë§ ë¯¸ë“¤ì›¨ì–´
app.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
  console.error('Express ì˜¤ë¥˜ ë°œìƒ:', err);
  res.status(500).json({
    status: 'error',
    message: 'Internal server error',
    error: process.env.NODE_ENV === 'production' ? 'Internal error' : err.message
  });
});

try {
  // CORS ì„¤ì •
  app.use(cors({
    origin: '*', // ê°œë°œ ëª©ì ìœ¼ë¡œ ì„ì‹œë¡œ ëª¨ë“  ì˜¤ë¦¬ì§„ í—ˆìš©
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization', 'x-api-key']
  }));

  app.use(express.json());

  // ì •ì  íŒŒì¼ ì œê³µ ì„¤ì •
  app.use('/static', express.static(path.join(__dirname, '../static')));

  console.log('ê¸°ë³¸ ë¼ìš°íŠ¸ ì„¤ì • ì¤‘...');

  // ê¸°ë³¸ ìƒíƒœ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
  app.get('/', (req, res) => {
    res.status(200).json({ 
      status: 'ok', 
      message: 'Server is running', 
      timestamp: new Date().toISOString(),
      environment: process.env.NODE_ENV || 'development'
    });
  });

  // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
  app.get('/health', async (req, res) => {
    try {
      // íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ì´ˆ) - ì¶”ì  ê°€ëŠ¥í•œ íƒ€ì„ì•„ì›ƒ ì‚¬ìš©
      const timeoutId = createTrackedTimeout(() => {
        console.log("ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ ì²´í¬ íƒ€ì„ì•„ì›ƒ");
        res.status(200).json({ // 500 ëŒ€ì‹  200 ë°˜í™˜í•˜ì—¬ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ì¬ì‹œì‘ ë°©ì§€
          status: 'warning', 
          message: 'Database connection timeout, but server is running',
          timestamp: new Date().toISOString()
        });
      }, 5000);
      
      await prisma.$queryRaw`SELECT 1`;
      clearTimeout(timeoutId);
      
      res.status(200).json({ 
        status: 'ok', 
        message: 'Database connection successful',
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      console.error('Health check failed:', error);
      // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” DB ì—°ê²° ì‹¤íŒ¨í•´ë„ ì„œë²„ëŠ” ê³„ì† ì‹¤í–‰
      res.status(200).json({ // 500 ëŒ€ì‹  200 ë°˜í™˜í•˜ì—¬ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ì¬ì‹œì‘ ë°©ì§€
        status: 'warning', 
        message: 'Database connection failed, but server is running',
        timestamp: new Date().toISOString(),
        error: error instanceof Error ? error.message : String(error)
      });
    }
  });

  console.log('API ë¼ìš°í„° ë“±ë¡ ì‹œë„...');
  try {
    // API ë¼ìš°í„° ë“±ë¡
    app.use(API_PREFIX, apiRoutes);
    console.log('API ë¼ìš°í„° ë“±ë¡ ì„±ê³µ');
  } catch (routerError) {
    console.error('API ë¼ìš°í„° ë“±ë¡ ì‹¤íŒ¨:', routerError);
  }

  console.log('ìŠ¤ì›¨ê±° ì„¤ì • ì‹œë„...');
  // Swagger ì„¤ì •ì€ ë©”ëª¨ë¦¬ë¥¼ ë§ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í”„ë¡œë•ì…˜ì—ì„œëŠ” ì„ íƒì ìœ¼ë¡œ í™œì„±í™”
  if (process.env.NODE_ENV !== 'production' || process.env.ENABLE_SWAGGER === 'true') {
    try {
      setupSwagger(app);
      console.log('ìŠ¤ì›¨ê±° ì„¤ì • ì™„ë£Œ');
    } catch (swaggerError) {
      console.error('ìŠ¤ì›¨ê±° ì„¤ì • ì‹¤íŒ¨:', swaggerError);
    }
  }
} catch (setupError) {
  console.error('ì„œë²„ ì„¤ì • ì¤‘ ì˜¤ë¥˜:', setupError);
}

// ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì§€ì—° ì²˜ë¦¬ ë° ì„œë²„ ì‹œì‘
async function startServer() {
  // ì¤‘ë³µ ì‹œì‘ ë°©ì§€
  if (isServerStarting) {
    console.log('ì„œë²„ê°€ ì´ë¯¸ ì‹œì‘ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì‹œì‘ ë°©ì§€');
    return null;
  }
  
  if (isServerRunning) {
    console.log('ì„œë²„ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
    return null;
  }
  
  isServerStarting = true;
  let server: any = null;
  
  try {
    const isProduction = process.env.NODE_ENV === 'production';
    
    console.log(`ğŸš€ ì„œë²„ ì‹œì‘ ì¤€ë¹„ ì¤‘... ëª¨ë“œ: ${isProduction ? 'production' : 'development'}`);
    console.log(`ğŸ”Œ ì‚¬ìš©í•  í¬íŠ¸: ${PORT}`);
    
    // ì„œë²„ ë¨¼ì € ì‹œì‘ - ëª¨ë“  ì¸í„°í˜ì´ìŠ¤ì—ì„œ ìˆ˜ì‹ 
    return new Promise((resolve, reject) => {
      try {
        server = app.listen(PORT, () => {
          console.log(`ğŸš€ ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
          console.log(`ğŸš€ ì„œë²„ URL: ${isProduction ? 'https://trpg-dao-nft.onrender.com' : `http://localhost:${PORT}`}`);
          
          // ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŒì„ í™•ì¸í•˜ê¸° ìœ„í•œ ì¶”ê°€ ì½”ë“œ
          if (server && server.listening) {
            console.log('âœ… ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì´ë©° ìš”ì²­ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.');
            isServerStarting = false;
            isServerRunning = true;
            resolve(server);
          } else {
            console.error('âŒ ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆì§€ë§Œ ì •ìƒ ì‘ë™ ì¤‘ì¸ì§€ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            isServerStarting = false;
            reject(new Error('Server is not properly listening'));
          }
        });
        
        server.on('error', (err: any) => {
          console.error('ì„œë²„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
          isServerStarting = false;
          reject(err);
        });
        
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ìƒ ì¢…ë£Œ
        const gracefulShutdown = async () => {
          console.log('ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤...');
          
          // ìƒíƒœ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
          isServerRunning = false;
          
          // ëª¨ë“  íƒ€ì´ë¨¸ ì •ë¦¬ (ì¸í„°ë²Œ + íƒ€ì„ì•„ì›ƒ)
          clearAllTimers();
          
          if (server) {
            server.close(async () => {
              try {
                console.log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë¦¬ ì¤‘...');
                await prisma.$disconnect();
                console.log('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
              } catch (error) {
                console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', error);
              } finally {
                // ë©”ëª¨ë¦¬ ì •ë¦¬ íŒíŠ¸
                forceGC();
                console.log('ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì •ìƒ ì¢…ë£Œ ì½”ë“œ ì‚¬ìš©
                process.exit(0);
              }
            });
            
            // HTTP ìš”ì²­ ê°•ì œ ì¢…ë£Œ ì‹œê°„ ì•Œë¦¼
            createTrackedTimeout(() => {
              console.log('ì„œë²„ê°€ ì—¬ì „íˆ í™œì„± ì—°ê²°ì„ ë‹«ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
            }, 5000);
            
            // 10ì´ˆ í›„ì—ë„ ì¢…ë£Œë˜ì§€ ì•Šìœ¼ë©´ ê°•ì œ ì¢…ë£Œ
            createTrackedTimeout(() => {
              console.error('ì„œë²„ê°€ 10ì´ˆ ë‚´ì— ì •ìƒ ì¢…ë£Œë˜ì§€ ì•Šì•„ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤.');
              process.exit(1);
            }, 10000);
          } else {
            console.log('ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.');
            process.exit(0);
          }
        };
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€
        ['SIGTERM', 'SIGINT'].forEach(signal => {
          process.removeAllListeners(signal);
          process.on(signal, gracefulShutdown);
        });
        
      } catch (startError) {
        console.error('ì„œë²„ ì‹œì‘ ê³¼ì •ì—ì„œ ì˜ˆì™¸ ë°œìƒ:', startError);
        isServerStarting = false;
        reject(startError);
      }
    });
  } catch (error) {
    console.error('ì„œë²„ ì‹œì‘ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
    isServerStarting = false;
    
    // ì„œë²„ê°€ ì´ë¯¸ ì‹œì‘ë˜ì—ˆë‹¤ë©´ ê³„ì† ì‹¤í–‰
    if (server && server.listening) {
      console.log('ì„œë²„ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ê³„ì† ì‹¤í–‰í•©ë‹ˆë‹¤.');
      isServerRunning = true;
      return server;
    } else {
      console.log('ì„œë²„ ì‹œì‘ ì‹œë„ ì‹¤íŒ¨');
      throw error; // ì¬ê·€ í˜¸ì¶œ ëŒ€ì‹  ì˜¤ë¥˜ ì „íŒŒ
    }
  }
}

// GC íš¨ìœ¨ì„ ìœ„í•œ í™ ìµœì í™” íŒíŠ¸ (V8 ì—”ì§„)
if (process.env.NODE_ENV === 'production') {
  forceGC();
}

// ì„œë²„ ì‹œì‘ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
(async () => {
  let retryCount = 0;
  const MAX_RETRIES = 3;
  let server = null;

  while (retryCount < MAX_RETRIES && !isServerRunning) {
    try {
      console.log(`ì„œë²„ ì‹œì‘ ì‹œë„ ${retryCount + 1}/${MAX_RETRIES}`);
      server = await startServer();
      
      if (server) {
        console.log('ì„œë²„ ì‹œì‘ ì™„ë£Œ');
        break;
      } else if (isServerRunning) {
        console.log('ì„œë²„ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
        break;
      }
    } catch (e) {
      console.error(`ì„œë²„ ì‹œì‘ ì‹œë„ ${retryCount + 1} ì‹¤íŒ¨:`, e);
      retryCount++;
      
      if (retryCount < MAX_RETRIES) {
        console.log(`5ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤... (${retryCount}/${MAX_RETRIES})`);
        await new Promise(resolve => setTimeout(resolve, 5000));
      }
    }
  }

  if (!server && !isServerRunning) {
    console.error(`ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: ${MAX_RETRIES}íšŒ ì‹œë„ í›„ ì¤‘ë‹¨`);
    process.exit(1);
  }
  
  // ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ë©´ ëª¨ë‹ˆí„°ë§ ì„¤ì •
  console.log('ì„œë²„ ëª¨ë‹ˆí„°ë§ ì„¤ì • ì¤‘...');
  
  // ì„œë²„ ì‹œì‘ ì‹œê°„ ê¸°ë¡
  const startTime = Date.now();
  
  // í†µí•© ë©”ëª¨ë¦¬ ë° ìƒíƒœ ëª¨ë‹ˆí„°ë§ (2ë¶„ë§ˆë‹¤ - ë¹ˆë„ ê°ì†Œ)
  const monitoringInterval = createTrackedInterval(() => {
    // ë©”ëª¨ë¦¬ ìƒíƒœ ì¶œë ¥
    const memoryUsage = process.memoryUsage();
    console.log('===== ë©”ëª¨ë¦¬ ë° ìƒíƒœ ëª¨ë‹ˆí„°ë§ =====');
    console.log(`[${new Date().toISOString()}] ì‹¤í–‰ ì‹œê°„: ${Math.round((Date.now() - startTime) / 1000 / 60)}ë¶„`);
    console.log(`RSS: ${Math.round(memoryUsage.rss / 1024 / 1024)}MB, Heap: ${Math.round(memoryUsage.heapUsed / 1024 / 1024)}MB/${Math.round(memoryUsage.heapTotal / 1024 / 1024)}MB`);
    
    // GC ì‹¤í–‰
    console.log('ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰...');
    forceGC();
  }, 120000); // 2ë¶„ë§ˆë‹¤ ì‹¤í–‰
  
  // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°ì§€ (15ë¶„ë§ˆë‹¤ - ë¹ˆë„ ê°ì†Œ)
  const leakDetectionInterval = createTrackedInterval(() => {
    console.log('ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°ì§€ ì‹¤í–‰...');
    trackMemoryUsage();
  }, 900000); // 15ë¶„ë§ˆë‹¤
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€
  process.removeAllListeners('beforeExit');
  
  // í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ ìœ ì§€
  process.stdin.resume();
})();
